# モンテカルロ積分
## 確率密度関数
ある確率によって起こる事象に割り当てられる値を確率変数という。確率変数は離散型確率変数(サイコロの目など)と連続型確率変数(無作為に選んだ人の身長など)に分けられる。
ある確率変数の分布を縦軸に度数、横軸に階級をとってグラフにしたものをヒストグラムという度数を全項目数で割ればその階級が全体に占める割合(相対度数)を求められる。連続型確率変数についてこれを考えるのは無限に階級を分割することに等しい。ヒストグラムの階級を分割すると、その階級に含まれる度数が減る。もし無限に階級を分割すれば無限個の「度数0の階級」がうまれることになる。そこで連続型確率変数の場合は縦軸を各階級の度数ではなく全体に対する密度で表す。各階級の密度は以下の式で求められる。
```math
階級の密度 =\frac{その階級にある項目の数}{全項目の数 ✕ 階級幅}
```
連続型確率変数においては確率変数 $X$ がある区間[a, b]の間に収まる確率 $P(a\leq X \leq b)$ を確率密度関数 $p(x)$ の積分によって以下のように表すことができる。
```math
P(a\leq X \leq b) = \int_{a}^{b}p
(x)dx
```
したがって確率変数Xが微小区間[ $x, x+dx$ ]に含まれる値を取る確率は $p(x)dx$ である。
<!-- ![image](https://inzkyk.xyz/ray_tracing_in_one_weekend/fig-histogram.jpg) -->



## モンテカルロ積分とは
離散型確率変数Xの取りうる値を $x_1$, $x_2$ ,,, $x_n$ 、それぞれの確率を $p_1$, $p_2$ ,,,  $p_n$ とすると、期待値Eは
```math
E=\sum_{i = 1}^{n} x_ip_i
```
と表される。
連続型確率変数の場合、ある確率密度関数 $p(x)$ で分布する乱数 $x$ を用いると、確率が $p(x)dx$ であらわされることから、確率変数 $f(x)$ の期待値は
```math
E = \int_{-∞}^{∞}f(x)p(x)dx
```
で表される。  
これは、 $p(x)$ に従うN個の乱数 $x_1$ , $x_2$ ,,, $x_n$ を用いて、 $f(x_i)$ の平均を取ることで以下のように近似できる。
```math
E = \int_{-∞}^{∞}f(x)p(x)dx ≈ \frac{1}{N}\sum_{i=1}^{N}f(x_i)
```
したがって、区間[a, b]におけるある関数f(x)の積分
```math
I=\int_{a}^{b}f(x)dx
```
は
```math
I=\int_{a}^{b}f(x)dx ≈ \frac{1}{N}\sum_{i=1}^{N}\frac{f(x_i)}{p(x_i)}
```
で近似できる。  
大数の法則によれば，Nを十分に大きくすると，真値に収束すると考えることができる。
このように乱数を用いて積分結果の推定値を求める方法をモンテカルロ積分という。

## 累積分布関数
では、ある確率密度関数p(x)に沿った乱数を生成するにはどうすればよいだろうか。  
それには以下のように定義される**累積分布関数**(cumulative distribution function, **CDF**) $P(x)$ という概念が必要になる。  
```math
P(x)=\int_{-∞}^{x}p(t)dt
```
CDFからPDFを求めるには導関数を取れば良い。
```math
p(x) = \frac{d}{dx}P(x)
```

区間[0, 1]で一様分布する乱数 $u$ を用いて、とある確率密度関数 $p(x)$ に沿って乱数を生成する関数 $f(u)$ を考える。
 $P(x)$ は $f(u)$ の値が $x$ よりも小さい確率を表す。　
よってある定数 $a$ に対し
```math
P_a = P(a)
```
が得られたとき、 $f(u)$ が $a$ より小さい確率は $P_a$ となる。ここで $u$ は0から1の間で一様に分布することを思い出す。 $f$ が単調増加すると仮定すると、 $P_a$ は $u$ の値が $0$ から $P_a$ の区間に入る確率と等しくなる。
したがって以下のように累積確率と出力 $f(u)$ の累積確率が対応すると考えられる。
```math
f(P_a) = a
```
例えば $P(3) = 0.3$ つまり、 $f(u)$ の出力が $3$ より小さい確率が $0.3$ だったとすると、ランダムな入力 $u$ が $0.3$ を超えない確率は当然 $0.3$ であり $f(x)$ は入力が大きければ出力される値も大きくなるため $f(0.3) = 3$ と分かる。

したがって、以下のような関係が得られる。
```math
f(P(x)) = x
```
すなわち
```math
f(x) = P^{-1}(x)
```
よって確率密度関数 $p(x)$ に従って分布す乱数を生成する関数 $f(x)$ は、その確率密度関数における累積分布関数 $P(x)$ の逆関数である。

## 重点サンプリング
いまいちど 先程示した下の積分を考える。
 $x_i$ は区間[a, b]内で確率密度関数 $p(x)$ に従って分布しする。
```math
I=\int_{a}^{b}f(x)dx ≈ \frac{1}{N}\sum_{i=1}^{N}\frac{f(x_i)}{p(x_i)} = \hat{I}_N
```
先程述べたようにモンテカルロ積分は、確率密度関数がpの乱数xを大量に生成し、それらに関する $\frac{f(x)}{p(x)}$ の平均を求める。この平均値が積分の結果の値に収束する。  
期待値 $E[\hat{I}_N]$ は以下のように $f(x)$ の積分の結果と等しい。
```math
E[\hat{I}_N] = \int_{a}^{b}\frac{f(x)}{p(x)}p(x)dx = I
```
モンテカルロ法は高次元積分でも適用できる、計算が早いといった利点がある一方、実現値の収束が遅く、サンプリング数を大きくしないと真値に近づかないという欠点があるため、収束を早くする、つまり分散値を０に近づけることが重要になる。
分散 $V[\hat{I}_N]$ は
```math
\begin{aligned}

V[\hat{I}_N] &= V\Biggr[\frac{1}{N}\sum_{i=1}^{N}\frac{f(X_i)}{p(X_i)}\Biggr] \\

&= \frac{1}{N^2}\sum_{i=1}^{N}V\Biggr[\frac{f(X_i)}{p(X_i)}\Biggr] \\

\end{aligned}
```
ここで
```math
\begin{aligned}

V\Biggr[\frac{f(X)}{p(X)}\Biggr] &= E\Bigr[{\hat{I}_N}^2\Bigr] - E\Bigr[\hat{I}_N\Bigr]^2 \\
&= \int_{a}^{b}\Biggr(\frac{f(x)}{p(x)}\Biggr)^2p(x)dx - I^2 \\
&= \int_{a}^{b}\frac{f(x)^2}{p(x)}dx - I^2
\end{aligned}
```
 $I$ は定数なので、 $\int_{a}^{b}\frac{f(x)^2}{p(x)}dx$ を最小化する $p$ を求めれば良い。ただしpは以下を満たす。
```math
p(x)\geq0\ (a\leq x \leq b)\ ,\quad \int_{a}^{b}p(x)dx = 1
```
これを理論的には難解であるから、ここでは厳密な解析は割愛しもう少し感覚的に考えてみよう。
```math
\int_{a}^{b}\frac{f(x)^2}{p(x)}dx
```
この値をできるだけ小さくするには、とにかく $p(x)$ を大きくすれば良いのではと思うかもしれないが $p$ は $\int_{a}^{b}p(x)dx = 1$ という条件があるため、 $p(x)$ の値は常に大きくはできない。どこかで $f(x)$ が $p(x)$ よりも著しく大きくなってしまう。ではどうするか。区間[a, b]で $p$ ができるだけ $f(x)$ と常に近い値をとれば良いのである。したがって $p$ が $f$ の近似として優れていればそれだけ収束も速くなる。

## 球上の点を用いたモンテカルロ積分
先程は確率密度 $p(x)$ に基づいてサンプルする乱数 $x$ を用いて $f(x)$ を積分したが、我々がレイトレーシングで用いる乱数とは3次元空間の方向 $ω$ を意味している。方向 $ω$ は3次元空間の単位球面上の点として表すことができる。したがって方向 $ω$ による関数 $f(ω)$ の積分は球面上の面積 $S^2$ に関する積分として、3次元球面上の微小面積 $dσ$ を用いて次ように表される。
```math
\int_{S^2}f(ω)dσ
```
方向 $ω$ は原点と単位球面上の点を結ぶ動径とz軸とのなす角 $θ$ とxy平面への動径の射影とx軸のなす角 $φ$ をもちいて、 $ω = (θ, φ)$ と表すことができる。これは半径が常に1の3次元極座標と言い換えてもよい。  
ここでは例題として以下の積分を計算してみよう。
```math
\int_{S^2}cos^2θdσ
```
単位球面の面積要素 $dσ$ には $dσ = sinθdθdφ$ という等式が成り立つ。 ([参照リンク](https://www.youtube.com/watch?v=aNoEzONgIYo))  
したがって、
```math
\begin{aligned}
\int_{S^2}cos^2θdσ &= \int_{0}^{2π}\int_{0}^{π}cos^2θsinθdθdφ \\
\end{aligned}
```
ここで $u = cosθ$ と置くと $du = -sinθdθ$ である。
また、 $θ = 0$ のとき $u = 1$ 、 $θ = π$ のとき $u = -1$なので
```math
\begin{aligned}
\int_{0}^{π}cos^2θsinθdθdφ &= \int_{1}^{-1}u^2(-du) \\
&= \int_{-1}^{1}u^2du = \biggr[\frac{u^3}{3}\biggr]_{-1}^{1} = \frac{2}{3}
\end{aligned}
```
また
```math
\int_{0}^{2π}dφ = 2π
```
より
```math
\begin{aligned}
\int_{0}^{2π}\int_{0}^{π}cos^2θsinθdθdφ &= \Bigr(\int_{0}^{2π}dφ\Bigr)\Bigr(\int_{0}^{π}cos^2θsinθdθdφ\Bigr) \\
&= 2π⋅\frac{2}{3} = \frac{4π}{3}
\end{aligned}
```
となる。  
これをモンテカルロ積分で近似的に求めるとどうなるだろうか。
確率密度 $p(ω)$ にしたがって方向 $ω$ をサンプリングし $cos^2θ/p(ω)$ を計算する。ここでは方向 $ω$ を表す単位球面上の点が一様に選ばれるとすると $p(ω)$ は常に一定でかつ全体に渡る積分が1であるから、 $p(ω) =  1/(単位球面の面積) = 1/4π$ となる。また $cos^2θ$ で $θ$ はz軸との角度を表し、 $ω$ を極座標からxyz空間の直行座標へ変換すると $ω(θ, φ) = (sinθcosϕ, sinθsinϕ, cosθ​)$ のように表されるので、モンテカルロ積分の結果は次のように計算できる。
```math
\begin{aligned}
\frac{1}{N}\sum_{i=1}^{N}\frac{cos^2θ}{p(ω)} &= \frac{1}{N}\sum_{i=1}^{N}4πz^2
\end{aligned}
```
 $z$ はランダムな単位ベクトルのz成分を表す。これをプログラムにしたのが以下である。
```
double pdf(direction p)
{
	return (1 / (4.0 * M_PI));
}

#include <stdio.h>
int main(void)
{
	int		N = 147483647;
	double	sum = 0.0;
	for (int i = 0; i < N; i++)
	{
		direction	d = random_unit_direction(); // ランダムな方向を指す単位ベクトルを返す関数
		double		cos_squared = d.z * d.z;
		sum += cos_squared / pdf(d);
	}
	printf("I = %f\n", sum / N);
}

// 出力例:　I = 4.188611 (乱数を用いるため実行するたびに変化する。)
```
結果は $4π/3$ の近似になっている

# 光の散乱
今回行うレイトレーシングと積分にどんな関係があるのだろうか？
我々が行っているレイトレーシングとは、各ピクセルにレイを飛ばしそのピクセルの色を計算させる行為である。レイはカメラから放たれ、オブジェクトとの衝突点で散乱しまた次のレイを飛ばす。したがってレイトレーシングにおいて色の計算ではレイを引数として色を返す関数を作成し、衝突点を中心とする半球上の点で表されるあらゆる方向についてこの関数を積分する。そしてそれを拡散したレイについても再帰的に繰り返すことでシュミレーションを行うのである。

## アルベドと散乱
物体に入射した光のうちすべてが反射されるわけではなく一部は物体に吸収される。プログラムでは物質ごとの光を反射する割合 $A$ で表しコレを**アルベド**と呼ぶ。反射率は色によって異なるためRGBの3値で表される。光が吸収される確率は $1 - A$ で表すことができる。  

光が衝突点から散乱するとき、散乱レイの方向の分布は散乱する方向 $ω_o$ を引数にとるPDFとして表される。これを以降は散乱PDFと呼び、 $pScatter(ω_o)$ と表す。散乱PDFをある立体角で積分するとその立体角の内側に光が散乱する確率を求めることができる。
散乱PDFは入射方向によっても変化する場合があるため次のように表す: $pScatter(ω_o, ω_i)$ 。  
物体の表面で散乱する光の色 $Color_o$ は入射してくる光の色 $Color_i$ とアルベド $A$ 、散乱PDF $pScatter(ω_o, ω_i)$ の積をすべての入射方向 $Ω_i$ の範囲で積分することで次のように表せる。
```math
Color_o = \int_{Ω_i}Color_i\cdot A\cdot pScatter(ω_o, ω_i)dω_i
```
入射光の色 $Color_i$ もまたその光が反射してきた物体表面で同様の計算をして求められるためこれは再帰的なアルゴリズムである。

## 散乱PDF
先程の積分を、モンテカルロ積分を使って推定していきたい。一回の試行では入射方向 $ω_i$ に対してその入射方向のPDF $p(ω_i)$ を用いて、以下の式を計算することになる。
```math
Color_ o = \frac{Color_i\cdot A\cdot pScatter(ω_o, ω_i)}{p(ω_i)}
```
理想的な拡散反射では**ランバートの余弦則**